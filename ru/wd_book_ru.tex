%\documentclass{tufte-book}
\documentclass[nofonts,justified,nobib]{tufte-book}% good in Ubuntu
%\documentclass[nofonts,justified, nobib]{tufte-book}
%                                 tufte-book modifies the \cite-command heavily, you can turn this behavior off, using the nobib-option:  

\usepackage{cmap} % comment out in Ubuntu


% https://tex.stackexchange.com/a/45949/99685 switch from natbib to biblatex 
\usepackage{hyphenat}
\usepackage[
%  style=verbose, citepages=omit, % too long title at margins
%  style=authoryear, % e.g. Кузьмина 2021 or Магера 2018.
%  
%  style=authortitle, % Кузьмина, “Аниме:..."
  style=authortitle-ibid,
  dashed=false, % in Bibliography dash if authors repeated
  autocite=footnote, 
  autopunct=false, % see https://ctan.math.illinois.edu/macros/latex/contrib/biblatex/doc/biblatex.pdf
%                  % a trailing punctuation mark will not be moved against footnote mark
  maxcitenames=1,
  backend=biber
]{biblatex}
\addbibresource{wd_references.bib}
\ExecuteBibliographyOptions{citetracker=true}

\usepackage{xurl} % break long url, see https://tex.stackexchange.com/a/407368/99685

% + shorttitle if twice of more references to the same biblio reference
% https://tex.stackexchange.com/a/26084/99685
\renewbibmacro*{cite:short}{% based on cite:short from verbose.cbx
  \printtext[bibhyperlink]{\printnames{labelname}}%
  \iffieldundef{shorttitle}
    {}
    {\setunit*{\nametitledelim}%
     \printfield[citetitle]{labeltitle}}}

\renewbibmacro*{cite:short}{% based on cite:short from verbose.cbx
  \printtext[bibhyperlink]{\printnames{labelname}}%
  \iffieldundef{shorttitle}
    {}
    {\setunit*{\nametitledelim}%
     \printfield[citetitle]{labeltitle}}}



% source tufte-latex
%\usepackage[T1]{fontenc}
%\usepackage[english,russian]{babel}
%\usepackage[utf8]{inputenc}

% new, see https://tex.stackexchange.com/a/333416
\usepackage[T1]{fontenc} % good in Ubuntu
%\usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[russian]{babel} % good in Ubuntu
%\usepackage[english,russian]{babel}
\usepackage[scaled=.85]{PTMono}

\usepackage[babel=true]{microtype} % good in Ubuntu see https://tex.stackexchange.com/a/355726/99685

% Select font you like
\usepackage{paratype} % very good in Ubuntu
%\usepackage{libertine} % not bad
%\usepackage{tempora}  % too heavy

%\usepackage{iwona} % so-so
%\usepackage{opensans} % so-so
%\usepackage{droid} % not best
%\usepackage{kurier} % not best
%\usepackage{cantarell} % ? 
%\usepackage{lmodern}

\usepackage{indentfirst} % red entries

% see https://lisakov.com/blog/latex-fonts/
% Шрифты в Latex
%\usepackage{libertine}
%\usepackage{paratype}

\usepackage{setspace} % see https://tex.stackexchange.com/a/77910/99685
%\doublespacing
% \begin{spacing}{2.5} ... \end{spacing}

\usepackage[colorinlistoftodos,prependcaption,textsize=large]{todonotes} %see https://tex.stackexchange.com/a/178806/99685

\usepackage{bookmark}% http://ctan.org/pkg/bookmark


% see https://mydebianblog.blogspot.com/2014/06/latex.html
\usepackage{epigraph} %%% to make inspirational quotes.

% https://tex.stackexchange.com/a/224875/99685
%\usepackage{natbib}           % call natbib
%\setcitestyle{authoryear}     % set citation style to authoryear
%\bibliographystyle{plainnat}  % use the plainnat instead of plain


% source: https://gist.github.com/vsimko/fcc84e1e4f8e750746caa34b802db5a7
\definecolor{LightGray}{rgb}{0.97,0.97,0.97}
\usepackage{listings} % syntax highlighting
\usepackage{xparse} % insert code keywords inline, see https://tex.stackexchange.com/a/286097/99685

\lstdefinelanguage{SPARQL}{
  basicstyle=\small\ttfamily,
  backgroundcolor=\color{LightGray},
  columns=fullflexible,
  breaklines=false,
  sensitive=true,
  % --------------------------
  frame=bt, % bottom and top lines
  aboveskip=1em,
  belowskip=1em,
  xleftmargin=.5em,
  xrightmargin=.5em,
  framexleftmargin=.5em,
  framextopmargin=.5em,
  framexbottommargin=.5em,
  framexrightmargin=.5em,
  % --------------------------
  tabsize = 2,
  showstringspaces=false,
  morecomment=[l][\color{gray}]{\#},       % comments
  morecomment=[n][\color{blue}]{<http}{>}, % uris
  morestring=[b][\color{OliveGreen}]{\"},  % strings
  % -------------------------- variables
  keywordsprefix=?,
  classoffset=0,
  keywordstyle=\color{Sepia},
  morekeywords={},
  % -------------------------- prefixes
  classoffset=1,
  keywordstyle=\color{Purple},
  morekeywords={rdf,rdfs,owl,xsd,purl},
  % -------------------------- keywords
  classoffset=2,
  keywordstyle=\color{MidnightBlue},
  morekeywords={
    SELECT,CONSTRUCT,DESCRIBE,ASK,WHERE,FROM,NAMED,PREFIX,BASE,OPTIONAL,
    FILTER,GRAPH,LIMIT,OFFSET,SERVICE,UNION,EXISTS,NOT,BINDINGS,MINUS,a
  }
}
%\lstset{language=SPARQL,frame=lines}

\lstloadlanguages{Python}
\input{listings-python.prf}
\lstset{
   language=Python,
   extendedchars=\true,
   keepspaces=true,
   frame=bt,
   basicstyle=\small\ttfamily,
   backgroundcolor=\color{LightGray},
   showstringspaces=false,
   showspaces=false,
   numbers=none,
   tabsize=2,
   breaklines=true,
   keywordstyle=\color{Sepia},
   stringstyle=\color{OliveGreen}
%   captionpos=b
}
% see https://alexanius-blog.blogspot.com/2012/09/lstlistings.html
% extendedchars=\true,


% see https://tex.stackexchange.com/a/79985/99685
\usepackage{siunitx} % \num{12345,67890}


% links to Russian Wikipedia articles \ruwiki{short w.wiki link}{Москва}
% for example \ruwiki{vDw}{МиГ} = \href{https://w.wiki/vDw}{МиГ}
% see https://tex.stackexchange.com/a/86368/99685
\usepackage{texlinks} 
%\newcommand*{\ruwiki}{\wikilangref{ru}} - failed cyrillic in URL
% \href{https://w.wiki/vDw}{МиГ} -> \ruwiki{vDw}{МиГ}
\newcommand{\ruwiki}[2]{\href{https://w.wiki/#1}{#2}}

% full link to short URL created by URL Shortener, 
% e.g. \wwiki{XYZ} = \href{https://w.wiki/XYZ}{https://w.wiki/XYZ}
\newcommand{\wwiki}[1]{\href{https://w.wiki/#1}{https://w.wiki/#1}}

% two parameters in case of special symbols in URL, e.g. $ = %24
% e.g. \wwiki{X\%24Z}{X$Y} = \href{https://w.wiki/X\%24Z}{https://w.wiki/X$Z}
% \newcommand{\wwiki}[1]{\href{https://w.wiki/#1}{https://w.wiki/#1}} or better is the explicit command?


% Wikidata object hyperlink in the form: QID, e.g. Q312154
\newcommand{\wdq}[1]{\href{https://www.wikidata.org/wiki/Q#1}{Q#1}}
% Wikidata object hyperlink in the form: Name (QID), e.g. Drosophila (Q312154)
\newcommand{\wdqName}[2]{\href{https://www.wikidata.org/wiki/Q#2}{#1~(Q#2)}}

% Wikidata object property name and hyperlink
% \wdproperty{ID}{Name} = \href{https://www.wikidata.org/wiki/Property:PID}{Name (PID)}
\newcommand{\wdProperty}[2]{\href{https://www.wikidata.org/wiki/Property:P#1}{#2 (P#1)}}

% How to add a forced line break inside a table cell
% https://tex.stackexchange.com/a/19678
\newcommand{\specialcell}[2][c]{%
  \begin{tabular}[#1]{@{}c@{}}#2\end{tabular}}


% comment all in Ubuntu
%\renewcommand{\rmdefault}{cmr} % CM roman
%\renewcommand{\sfdefault}{cmss} % CM sans serif 
%\renewcommand{\ttdefault}{cmtt} % CM monospaced 

%\renewcommand{\rmdefault}{ptm} % Times 
%\renewcommand{\sfdefault}{phv}
%\renewcommand{\ttdefault}{pcr}



% Remove prefix from figure caption in tufte-book, see https://tex.stackexchange.com/a/106422/99685
\makeatletter
\newenvironment{nocapfigure}
  {\let\H@refstepcounter\@gobble%
   \long\def\@caption##1[##2]##3{%
   \par%
   %\addcontentsline{\csname ext@##1\endcsname}{##1}%
   %  {\protect\numberline{\csname the##1\endcsname}{\ignorespaces ##2}}%
   \begingroup%
     \@parboxrestore%
     \if@minipage%
       \@setminipage%
     \fi%
     \@tufte@caption@font\@tufte@caption@justification%
     \noindent\ignorespaces##3\par%\noindent\csname fnum@#1\endcsname: \ignorespaces#3\par%
     %\@makecaption{\csname fnum@#1\endcsname}{\ignorespaces #3}\par
   \endgroup}\figure
    }{\endfigure}
\makeatother

% If too much notes: see https://tex.stackexchange.com/a/175796/99685
%\usepackage{marginfix}

% how to use `\marginnote` in `mdframed` environment?, see https://tex.stackexchange.com/a/412839/99685
\usepackage[framemethod=TikZ]{mdframed}
%\let\marginnote\someundefinedcommand
%\usepackage{marginnote}

\newmdenv[skipabove=6mm]{mdfstyle}

\hypersetup{colorlinks}% uncomment this line if you prefer colored hyperlinks (e.g., for onscreen viewing)
%\usepackage{breakurl}% see https://tex.stackexchange.com/a/21266/99685

\setcounter{secnumdepth}{0} % turn on numbering for parts and chapters 

\usepackage{amsthm, amsmath, amssymb}
%\usepackage{setspace, enumerate}

\usepackage[linesnumbered,boxed]{algorithm2e}
\newcommand{\var}{\texttt} % for names of variables in plain text https://tex.stackexchange.com/a/381105/99685

\theoremstyle{definition}
\newtheorem{task}{} % numbering of tasks in the section: Answers

%%
% Book metadata
\title{Программирование \\Викиданных \\для школьников \\и студентов}
\author[Крижановский и др.]{Крижановский Андрей, Балакирева Мария, Меньшикова Екатерина, Паренченков Евгений, Потес Артём, Трубина Елизавета, Величков Иво, Обрегон Анхель}
%\author[Крижановский А. А., Балакирева М. С., Меньшикова Е. А., Паренченков Е. О., Потес А. С., Трубина Е. Д.]{Крижановский Андрей, Балакирева Мария, Меньшикова Екатерина, Паренченков Евгений, Потес Артём, Трубина Елизавета}
%\author[Крижановский Андрей, Иванов Иван]{Крижановский Андрей,\ Иванов Иван,\ добавьте свою фамилию и имя ...}
\publisher{Петрозаводский государственный университет,\\Карельский научный центр РАН}

%%
% If they're installed, use Bergamo and Chantilly from www.fontsite.com.
% They're clones of Bembo and Gill Sans, respectively.
%\IfFileExists{bergamo.sty}{\usepackage[osf]{bergamo}}{}% Bembo
%\IfFileExists{chantill.sty}{\usepackage{chantill}}{}% Gill Sans

%\usepackage{microtype}

%%
% Just some sample text
%\usepackage{lipsum}

%%
% For nicely typeset tabular material
\usepackage{booktabs}

%%
% For graphics / images
\usepackage{graphicx}
\setkeys{Gin}{width=\linewidth,totalheight=\textheight,keepaspectratio}
\graphicspath{{graphics/}}

% The fancyvrb package lets us customize the formatting of verbatim
% environments.  We use a slightly smaller font.
\usepackage{fancyvrb}
\fvset{fontsize=\normalsize}

%%
% Prints argument within hanging parentheses (i.e., parentheses that take
% up no horizontal space).  Useful in tabular environments.
\newcommand{\hangp}[1]{\makebox[0pt][r]{(}#1\makebox[0pt][l]{)}}

%%
% Prints an asterisk that takes up no horizontal space.
% Useful in tabular environments.
\newcommand{\hangstar}{\makebox[0pt][l]{*}}

%%
% Prints a trailing space in a smart way.
\usepackage{xspace}

%%
% Some shortcuts for Tufte's book titles.  The lowercase commands will
% produce the initials of the book title in italics.  The all-caps commands
% will print out the full title of the book in italics.
\newcommand{\vdqi}{\textit{VDQI}\xspace}
\newcommand{\ei}{\textit{EI}\xspace}
\newcommand{\ve}{\textit{VE}\xspace}
\newcommand{\be}{\textit{BE}\xspace}
\newcommand{\VDQI}{\textit{The Visual Display of Quantitative Information}\xspace}
\newcommand{\EI}{\textit{Envisioning Information}\xspace}
\newcommand{\VE}{\textit{Visual Explanations}\xspace}
\newcommand{\BE}{\textit{Beautiful Evidence}\xspace}

\newcommand{\TL}{Tufte-\LaTeX\xspace}

% Prints the month name (e.g., January) and the year (e.g., 2008)
\newcommand{\monthyear}{%
  \ifcase\month\or January\or February\or March\or April\or May\or June\or
  July\or August\or September\or October\or November\or
  December\fi\space\number\year
}


% Prints an epigraph and speaker in sans serif, all-caps type.
\newcommand{\openepigraph}[2]{%
  %\sffamily\fontsize{14}{16}\selectfont
  \begin{fullwidth}
  \sffamily\large
  \begin{doublespace}
  \noindent\allcaps{#1}\\% epigraph
  \noindent\allcaps{#2}% author
  \end{doublespace}
  \end{fullwidth}
}

% Inserts a blank page
\newcommand{\blankpage}{\newpage\hbox{}\thispagestyle{empty}\newpage}

\usepackage{units}

% Typesets the font size, leading, and measure in the form of 10/12x26 pc.
\newcommand{\measure}[3]{#1/#2$\times$\unit[#3]{pc}}

% Macros for typesetting the documentation
\newcommand{\hlred}[1]{\textcolor{Maroon}{#1}}% prints in red
\newcommand{\hangleft}[1]{\makebox[0pt][r]{#1}}
\newcommand{\hairsp}{\hspace{1pt}}% hair space
\newcommand{\hquad}{\hskip0.5em\relax}% half quad space
\newcommand{\TODO}{\textcolor{red}{\bf TODO!}\xspace}
\newcommand{\na}{\quad--}% used in tables for N/A cells
\providecommand{\XeLaTeX}{X\lower.5ex\hbox{\kern-0.15em\reflectbox{E}}\kern-0.1em\LaTeX}
\newcommand{\tXeLaTeX}{\XeLaTeX\index{XeLaTeX@\protect\XeLaTeX}}
% \index{\texttt{\textbackslash xyz}@\hangleft{\texttt{\textbackslash}}\texttt{xyz}}
\newcommand{\tuftebs}{\symbol{'134}}% a backslash in tt type in OT1/T1
\newcommand{\doccmdnoindex}[2][]{\texttt{\tuftebs#2}}% command name -- adds backslash automatically (and doesn't add cmd to the index)
\newcommand{\doccmddef}[2][]{%
  \hlred{\texttt{\tuftebs#2}}\label{cmd:#2}%
  \ifthenelse{\isempty{#1}}%
    {% add the command to the index
      \index{#2 command@\protect\hangleft{\texttt{\tuftebs}}\texttt{#2}}% command name
    }%
    {% add the command and package to the index
      \index{#2 command@\protect\hangleft{\texttt{\tuftebs}}\texttt{#2} (\texttt{#1} package)}% command name
      \index{#1 package@\texttt{#1} package}\index{packages!#1@\texttt{#1}}% package name
    }%
}% command name -- adds backslash automatically
\newcommand{\doccmd}[2][]{%
  \texttt{\tuftebs#2}%
  \ifthenelse{\isempty{#1}}%
    {% add the command to the index
      \index{#2 command@\protect\hangleft{\texttt{\tuftebs}}\texttt{#2}}% command name
    }%
    {% add the command and package to the index
      \index{#2 command@\protect\hangleft{\texttt{\tuftebs}}\texttt{#2} (\texttt{#1} package)}% command name
      \index{#1 package@\texttt{#1} package}\index{packages!#1@\texttt{#1}}% package name
    }%
}% command name -- adds backslash automatically
\newcommand{\docopt}[1]{\ensuremath{\langle}\textrm{\textit{#1}}\ensuremath{\rangle}}% optional command argument
\newcommand{\docarg}[1]{\textrm{\textit{#1}}}% (required) command argument
\newenvironment{docspec}{\begin{quotation}\ttfamily\parskip0pt\parindent0pt\ignorespaces}{\end{quotation}}% command specification environment
\newcommand{\docenv}[1]{\texttt{#1}\index{#1 environment@\texttt{#1} environment}\index{environments!#1@\texttt{#1}}}% environment name
\newcommand{\docenvdef}[1]{\hlred{\texttt{#1}}\label{env:#1}\index{#1 environment@\texttt{#1} environment}\index{environments!#1@\texttt{#1}}}% environment name
\newcommand{\docpkg}[1]{\texttt{#1}\index{#1 package@\texttt{#1} package}\index{packages!#1@\texttt{#1}}}% package name
\newcommand{\doccls}[1]{\texttt{#1}}% document class name
\newcommand{\docclsopt}[1]{\texttt{#1}\index{#1 class option@\texttt{#1} class option}\index{class options!#1@\texttt{#1}}}% document class option name
\newcommand{\docclsoptdef}[1]{\hlred{\texttt{#1}}\label{clsopt:#1}\index{#1 class option@\texttt{#1} class option}\index{class options!#1@\texttt{#1}}}% document class option name defined
\newcommand{\docmsg}[2]{\bigskip\begin{fullwidth}\noindent\ttfamily#1\end{fullwidth}\medskip\par\noindent#2}
\newcommand{\docfilehook}[2]{\texttt{#1}\index{file hooks!#2}\index{#1@\texttt{#1}}}
\newcommand{\doccounter}[1]{\texttt{#1}\index{#1 counter@\texttt{#1} counter}}


% Generates the index
\usepackage{makeidx}
\makeindex

\begin{document}

% Front matter
%\frontmatter

% r.1 blank page
%\blankpage

% v.2 epigraphs
%\newpage\thispagestyle{empty}
%\openepigraph{%
%The public is more familiar with bad design than good design.
%It is, in effect, conditioned to prefer bad design, 
%because that is what it lives with. 
%The new becomes threatening, the old reassuring.
%}{Paul Rand%, {\itshape Design, Form, and Chaos}
%%}
%\vfill
%\openepigraph{%
%A designer knows that he has achieved perfection 
%not when there is nothing left to add, 
%but when there is nothing left to take away.
%}{Antoine de Saint-Exup\'{e}ry}
%\vfill
%\openepigraph{%
%\ldots the designer of a new system must not only be the implementor and the first 
%large-scale user; the designer should also write the first user manual\ldots 
%If I had not participated fully in all these activities, 
%literally hundreds of improvements would never have been made, 
%because I would never have thought of them or perceived 
%why they were important.
%}{Donald E. Knuth}


% r.3 full title page
\maketitle


% v.4 copyright page
\newpage
\begin{fullwidth}
~\vfill
\thispagestyle{empty}
\setlength{\parindent}{0pt}
\setlength{\parskip}{\baselineskip}
Copyleft \textcopyleft\ \the\year\ \thanklessauthor

\par\smallcaps{Published by \thanklesspublisher}

\par\href{https://w.wiki/62E}{https://ru.wikiversity.org/wiki/Программирование\_Викиданных}

\par Пособие распространяется на правах свободной лицензии 
    \href{https://creativecommons.org/licenses/by-sa/4.0/deed.ru}{Creative Commons Attribution-ShareAlike}.


\par\textit{First printing, \monthyear}
\end{fullwidth}

% r.5 contents
\tableofcontents

\listoffigures

\listoftables

% r.7 dedication
\clearpage
\vfill
\begin{fullwidth}
\begin{doublespace}
\noindent\fontsize{18}{22}\selectfont\itshape
\nohyphenation
<<Что может быть проще примитивного нуль-передатчика? Только примитивный нуль-аккумулятор.>>

<<Обитаемый остров>>, \mbox{Аркадий и Борис Стругацкие}.
\end{doublespace}
\end{fullwidth}
%\vfill


\begin{fullwidth}
\begin{doublespace}
\noindent\fontsize{18}{22}\selectfont\itshape
%\nohyphenation
<<Эта машина, подпиравшая стены железными боками, была огромна. 
Электроник, поглощая цифры, скоро пришёл к выводу, что ему нужно сидеть здесь несколько суток\dots.

---~Я всего этого не запомню,~--- скрипуче сказал Электроник. ---~Миллионы цифр!

Слишком большое количество информации\dots

Профессор положил руку на его плечо.

---~Отключись,~--- посоветовал он. ---~Привыкать надо постепенно.>>

<<Рэсси~--- неуловимый друг>>, \mbox{Евгений Велтистов}.
\end{doublespace}
\end{fullwidth}
%\vfill


\begin{fullwidth}
\begin{doublespace}
\noindent\fontsize{18}{22}\selectfont\itshape
\nohyphenation
Книга посвящается всем изобретателям SPARQL-скриптов, 
    программистам будущего.
\end{doublespace}
\end{fullwidth}
%\vfill


% r.9 introduction
\cleardoublepage

\input{./intro/intro.tex}

%%
% Start the main matter (normal chapters)
\mainmatter

\part{Основы Викиданных}
\label{part:foundation}

\input{./intro/listings_about.tex}
\input{./intro/prowd.tex}

\input{./review/about_wd.tex}
\input{./intro/buckets_and_balls.tex}




\part{Исследуем объекты Викиданных}
\label{part:research}

\input{./chapter/aircraft.tex}
\input{./chapter/anime.tex}

\input{./chapter/human_settlement.tex}
\input{./chapter/city.tex}
\input{./chapter/country.tex}

\input{./chapter/national_park.tex}
\input{./chapter/oblast_of_Russia.tex}
\input{./chapter/operating_system.tex}
\input{./chapter/programming_language.tex}
\input{./chapter/ship.tex}
\input{./chapter/spacecraft_space_station.tex}


\part{Специальные возможности вики-проектов и Викиданных}
\label{part:advanced}
\input{./advanced/page_protection.tex}
\input{./advanced/bots.tex}


\part{Заключительный раздел}
\label{part:conclusion}
\input{./chapter/answers.tex}


%\section{Typography}\label{sec:typography}

%\subsection{Typefaces}\label{sec:typefaces}\index{typefaces}
%If the Palatino, \textsf{Helvetica}, and \texttt{Bera Mono} typefaces are installed, this style
%will use them automatically.  Otherwise, we'll fall back on the Computer Modern
%typefaces.


%%
% The back matter contains appendices, bibliographies, indices, glossaries, etc.


\backmatter

%\bibliographystyle{plainnat}
%\bibliography{wd_references}
\printbibliography 

\printindex

\end{document}

