%\documentclass{tufte-book}
\documentclass[nofonts,justified,nobib,openany,oneside]{tufte-book}% good in Ubuntu
%                                      'openany' removes blank pages between two chapters, https://stackoverflow.com/a/492148/1173350
%\documentclass[nofonts,justified, nobib]{tufte-book}
%                                 tufte-book modifies the \cite-command heavily, you can turn this behavior off, using the nobib-option:  

\usepackage{cmap} % comment out in Ubuntu


% https://tex.stackexchange.com/a/45949/99685 switch from natbib to biblatex 
\usepackage{hyphenat}

\usepackage[
% citestyle=gost-footnote-min, % wo URL in autocite
  citestyle=gost-footnote, % wo URL in autocite
  bibstyle=gost-footnote,
  citeurl=true,% footnotes and sidenotes with URL
%
%  style=verbose, citepages=omit, % too long title at margins
%  style=authoryear, % e.g. Кузьмина 2021 or Магера 2018.
%  
%  style=authortitle, % Кузьмина, “Аниме:..."
%
%% style=authortitle-ibid,
%%  dashed=false, % in Bibliography dash if authors repeated
%%%%  autolang=other,% multilingual bibliography
  autocite=footnote, 
%%  autopunct=false, % see https://ctan.math.illinois.edu/macros/latex/contrib/biblatex/doc/biblatex.pdf
%                  % a trailing punctuation mark will not be moved against footnote mark
  babel=other, % H. Turki [и др.] -> [et al.]
%  movenames=true, % or false, see https://ctan.math.illinois.edu/macros/latex/contrib/biblatex-contrib/biblatex-gost/doc/biblatex-gost.pdf, page 20
%%  maxcitenames=1,
%  maxbibnames=99, % displaying all authors of multi-author works in the bibliography
  otherlangs=true,
  backend=biber
]{biblatex}
\addbibresource{wd_references.bib}
\ExecuteBibliographyOptions{citetracker=true}

\usepackage{xurl} % break long url, see https://tex.stackexchange.com/a/407368/99685

\usepackage[unicode]{hyperref}

% + shorttitle if twice of more references to the same biblio reference
% https://tex.stackexchange.com/a/26084/99685
\renewbibmacro*{cite:short}{% based on cite:short from verbose.cbx
  \printtext[bibhyperlink]{\printnames{labelname}}%
  \iffieldundef{shorttitle}
    {}
    {\setunit*{\nametitledelim}%
     \printfield[citetitle]{labeltitle}}}

\renewbibmacro*{cite:short}{% based on cite:short from verbose.cbx
  \printtext[bibhyperlink]{\printnames{labelname}}%
  \iffieldundef{shorttitle}
    {}
    {\setunit*{\nametitledelim}%
     \printfield[citetitle]{labeltitle}}}



% source tufte-latex
%\usepackage[T1]{fontenc}
%\usepackage[english,russian]{babel}
%\usepackage[utf8]{inputenc}

% new, see https://tex.stackexchange.com/a/333416
\usepackage[utf8]{inputenc}
\usepackage[T1,T2A]{fontenc} % good in Ubuntu
%\usepackage[T2A]{fontenc}
%\usepackage[russian]{babel} % good in Ubuntu
\usepackage[english,russian]{babel}
%\usepackage[scaled=.85]{PTMono}

%\usepackage[babel=true]{microtype} % good in Ubuntu see https://tex.stackexchange.com/a/355726/99685
\usepackage{csquotes}

% Select font you like
%%%\usepackage{paratype} % very good in Ubuntu
%\usepackage{libertine} % not bad
%%%\usepackage{tempora}  % too heavy


%\usepackage{erewhon} % good bold
%\usepackage{XCharter} % 
\usepackage{cochineal} % good narrow bold best
%\usepackage{lato} % 
%\usepackage{cmsrb} % 
%\usepackage{gentium} % 



%\usepackage{iwona} % so-so
%\usepackage{opensans} % so-so
%\usepackage{droid} % not best - failed
%\usepackage{kurier} % not best
%\usepackage{cantarell} % ? 
%\usepackage{lmodern}

\usepackage{indentfirst} % red entries

% see https://lisakov.com/blog/latex-fonts/
% Шрифты в Latex
%\usepackage{libertine}
%\usepackage{paratype}

%\usepackage{setspace} % see https://tex.stackexchange.com/a/77910/99685
%\doublespacing
% \begin{spacing}{2.5} ... \end{spacing}

% Place footnote in footer in Tufte-book class
% https://tex.stackexchange.com/a/417552/99685
\usepackage{tuftefoot}

% русскоязычные источники предшествовали остальным в Литературе 
\usepackage{biblio-gost-ru-before-en}


% %%%%%%%%%%%%%%%%%%
% todonotes block

\usepackage{xargs} % \newcommandx - see below - Use more than one optional parameter in a new commands

\newcounter{todocounter} 

%see https://tex.stackexchange.com/a/178806/99685
\usepackage[colorinlistoftodos,prependcaption,textsize=large]{todonotes}
\setuptodonotes{inline} % only inline todo notes, without remarks and references at margins

\newcommandx{\todoVlad}[2][1=]{\stepcounter{todocounter}\todo[backgroundcolor=Apricot!25,bordercolor=red,#1]{\thetodocounter: #2}}
\newcommandx{\todoVladWithoutCounter}[2][1=]{\todo[backgroundcolor=Apricot!25,bordercolor=red,#1]{#2}}

\newcommandx{\answerVlad}[2][1=]{\todo[backgroundcolor=Green!25,bordercolor=violet,#1]{#2}}

% eo todonotes block
% %%%%%%%%%%%%%%%%%%


\usepackage{bookmark}% http://ctan.org/pkg/bookmark


% do not add this package, it changes everything drastically
%\usepackage{floatrow}   % Two figures side by side in Tufte-Latex, https://tex.stackexchange.com/a/392927/99685

% How to remove the whitespace BEFORE itemize/enumerate?
\usepackage[shortlabels]{enumitem}% https://tex.stackexchange.com/a/86055/99685

\newenvironment{compactitemize}{%
    \begin{itemize}[noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt]}{\end{itemize}}
%\begin{compactitemize} 

% see https://mydebianblog.blogspot.com/2014/06/latex.html
\usepackage{epigraph} %%% to make inspirational quotes.


% https://tex.stackexchange.com/a/224875/99685
%\usepackage{natbib}           % call natbib
%\setcitestyle{authoryear}     % set citation style to authoryear
%\bibliographystyle{plainnat}  % use the plainnat instead of plain




% documentation: https://mirror.truenetwork.ru/CTAN/macros/latex/contrib/ccaption/ccaption.pdf
%\newcommand{\captiondelim}[1]{\def\@contdelim{#1}}
%\captiondelim{--- }

% source: https://gist.github.com/vsimko/fcc84e1e4f8e750746caa34b802db5a7
\definecolor{LightGray}{rgb}{0.97,0.97,0.97}
\usepackage{soul,listings} % syntax highlighting
\usepackage{xparse} % insert code keywords inline, see https://tex.stackexchange.com/a/286097/99685


% Listing N: Title -> Query N. Title
% before \usepackage{listings}
\renewcommand{\lstlistingname}{Запрос}  % Листинг -> Запрос
%\renewcommand{\lstlistingname}{Листинг} % Запрос -> Листинг

\makeatletter
\long\def\@makecaption#1#2{%
%    \renewcommand{\lstlistingname{\protect\text{Query}}}{}
    \renewcommand{\lstlistingname}{Запрос}
\centering%
#1. #2\par%
%XX1#1.XX2 YY1#2YY2\par%
\vspace{\belowcaptionskip}% too large vertical gap
\vspace{5pt}% vertical distance from Request title the source code
}%
\makeatother

% Listing -> Query
%\renewcommand\lstlistingname{Запрос}

\lstdefinelanguage{SPARQL}{%
  texcl=true,
  basicstyle=\small\ttfamily,
  backgroundcolor=\color{LightGray},
  columns=fullflexible,
  breaklines=false,
  sensitive=true,
  % --------------------------
  frame=bt, % bottom and top lines
  aboveskip=1em,
  belowskip=1em,
  xleftmargin=.5em,
  xrightmargin=.5em,
  framexleftmargin=.5em,
  framextopmargin=.5em,
  framexbottommargin=.5em,
  framexrightmargin=.5em,
  % --------------------------
  tabsize = 2,
  showstringspaces=false,
  morecomment=[l][\color{gray}]{\#},       % comments
  morecomment=[n][\color{blue}]{<http}{>}, % uris
  morestring=[b][\color{OliveGreen}]{\"},  % strings
  % -------------------------- variables
  keywordsprefix=?,
  classoffset=0,
  keywordstyle=\color{Sepia},
  morekeywords={},
  % -------------------------- prefixes
  classoffset=1,
  keywordstyle=\color{Purple},
  morekeywords={rdf,rdfs,owl,xsd,purl},
  % -------------------------- keywords
  classoffset=2,
  keywordstyle=\color{MidnightBlue},
  morekeywords={
    SELECT,CONSTRUCT,DESCRIBE,ASK,WHERE,FROM,NAMED,PREFIX,BASE,OPTIONAL,
    FILTER,GRAPH,LIMIT,OFFSET,SERVICE,UNION,EXISTS,NOT,BINDINGS,MINUS,a
  },
  %\lst@ifdisplaystyle\scriptsize\fi
}
%\lstset{language=SPARQL,frame=lines}

\lstloadlanguages{Python}
\input{listings-python.prf}
\lstset{%
   language=Python,
   texcl=true,
   extendedchars=\true,
   keepspaces=true,
   frame=bt,
   basicstyle=\small\ttfamily,
   backgroundcolor=\color{LightGray},
   showstringspaces=false,
   showspaces=false,
   numbers=none,
   tabsize=2,
   breaklines=true,
   keywordstyle=\color{Sepia},
   stringstyle=\color{OliveGreen}
%   captionpos=b
}
% see https://alexanius-blog.blogspot.com/2012/09/lstlistings.html
% extendedchars=\true,


% color row in table via \rowcolor{LightCyan}
% https://texblog.org/2011/04/19/highlight-table-rowscolumns-with-color/
\definecolor{LightCyan}{rgb}{0.88,1,1}
\usepackage{colortbl}

% see https://tex.stackexchange.com/a/79985/99685
\usepackage{siunitx}[=v2] % \num{12345,67890}


% links to Russian Wikipedia articles \ruwiki{short w.wiki link}{Москва}
% for example \ruwiki{vDw}{МиГ} = \href{https://w.wiki/vDw}{МиГ}
% see https://tex.stackexchange.com/a/86368/99685
\usepackage{texlinks} 
%\newcommand*{\ruwiki}{\wikilangref{ru}} - failed cyrillic in URL
% \href{https://w.wiki/vDw}{МиГ} -> \ruwiki{vDw}{МиГ}
\newcommand{\ruwiki}[2]{\href{https://w.wiki/#1}{#2}}

% full link to short URL created by URL Shortener, 
% e.g. \wwiki{XYZ} = \href{https://w.wiki/XYZ}{https://w.wiki/XYZ}
\newcommand{\wwiki}[1]{\href{https://w.wiki/#1}{https://w.wiki/#1}}

% two parameters in case of special symbols in URL, e.g. $ = %24
% e.g. \wwiki{X\%24Z}{X$Y} = \href{https://w.wiki/X\%24Z}{https://w.wiki/X$Z}
% \newcommand{\wwiki}[1]{\href{https://w.wiki/#1}{https://w.wiki/#1}} or better is the explicit command?


% Wikidata object hyperlink in the form: QID, e.g. Q312154
\newcommand{\wdq}[1]{\href{https://www.wikidata.org/wiki/Q#1}{Q#1}}
% Wikidata object hyperlink in the form: Name (QID), e.g. Drosophila (Q312154)
\newcommand{\wdqName}[2]{\href{https://www.wikidata.org/wiki/Q#2}{#1~(Q#2)}}

% Wikidata object property name and hyperlink
% \wdproperty{ID}{Name} = \href{https://www.wikidata.org/wiki/Property:PID}{Name (PID)}
\newcommand{\wdProperty}[2]{\href{https://www.wikidata.org/wiki/Property:P#1}{#2 (P#1)}}

% How to add a forced line break inside a table cell
% https://tex.stackexchange.com/a/19678
\newcommand{\specialcell}[2][c]{%
  \begin{tabular}[#1]{@{}c@{}}#2\end{tabular}}


% comment all in Ubuntu
%\renewcommand{\rmdefault}{cmr} % CM roman
%\renewcommand{\sfdefault}{cmss} % CM sans serif 
%\renewcommand{\ttdefault}{cmtt} % CM monospaced 

%\renewcommand{\rmdefault}{ptm} % Times 
%\renewcommand{\sfdefault}{phv}
%\renewcommand{\ttdefault}{pcr}




%%% Draft (debug) or release version of the book
\makeatletter
\@ifundefined{c@draft}{
  \newcounter{draft}
  \setcounter{draft}{1} % 0 --- clean release version, without any comments, 
}{}                     %       with only finished chapters.
\makeatother            % 1 --- draft version, unfinished chapters included, 
                        %       with questions and comments
%%% eo Draft or release




% Remove prefix from figure caption in tufte-book, see https://tex.stackexchange.com/a/106422/99685
%\makeatletter
%\newenvironment{nocapfigure}
%  {\let\H@refstepcounter\@gobble%
%   \long\def\@caption##1[##2]##3{%
%   \par%
   %\addcontentsline{\csname ext@##1\endcsname}{##1}%
   %  {\protect\numberline{\csname the##1\endcsname}{\ignorespaces ##2}}%
%   \begingroup%
%     \@parboxrestore%
%     \if@minipage%
%       \@setminipage%
%     \fi%
%     \@tufte@caption@font\@tufte@caption@justification%
%     \noindent\ignorespaces##3\par%\noindent\csname fnum@#1\endcsname: \ignorespaces#3\par%
     %\@makecaption{\csname fnum@#1\endcsname}{\ignorespaces #3}\par
%   \endgroup}\figure
%    }{\endfigure}
%\makeatother



% -> "Рис. 8.4. Карта соседних стран..."
%\makeatletter
%\long\def\@caption#1[#2]#3{%
%  \par
%  \addcontentsline{\csname ext@#1\endcsname}{#1}%
%    {\protect\numberline{\csname the#1\endcsname}{\ignorespaces #2}}%
%  \begingroup
%    \@parboxrestore
%    \if@minipage
%      \@setminipage
%    \fi
%    \@tufte@caption@font\@tufte@caption@justification
%    \noindent\csname fnum@#1\endcsname. \ignorespaces#3\par% changed : to .
%%    \noindent ss \csname fnum@#1\endcsname. ll \ignorespaces#3 ii\par% changed : to .
%  \endgroup}
%\makeatother




% If too much notes: see https://tex.stackexchange.com/a/175796/99685
%\usepackage{marginfix}

% how to use `\marginnote` in `mdframed` environment?, see https://tex.stackexchange.com/a/412839/99685
\usepackage[framemethod=TikZ]{mdframed}
\usepackage{twemojis}% used in items in Chapter. Advanced. Защита страниц
%%% $\twemoji[width=24pt]{computer}$\,\, 

%\let\marginnote\someundefinedcommand
%\usepackage{marginnote}

%\newmdenv[skipabove=6mm]{mdfstyle}

\hypersetup{colorlinks}% uncomment this line if you prefer colored hyperlinks (e.g., for onscreen viewing)
%\usepackage{breakurl}% see https://tex.stackexchange.com/a/21266/99685

\setcounter{secnumdepth}{0} % turn on numbering for parts and chapters 

\usepackage{amsthm, amsmath, amssymb}
%\usepackage{setspace, enumerate}

\usepackage[linesnumbered,boxed]{algorithm2e}
\newcommand{\var}{\texttt} % for names of variables in plain text https://tex.stackexchange.com/a/381105/99685

\newtheoremstyle{definition}%
{}
{}
{}%{\itshape}%bodyfont
{}%indent
{}%{\bfseries}%headfont
{}%head punctuation
{ }% space after head - e.g. \parindent paragraph indent before Answer.
{}

\theoremstyle{definition}
\newtheorem*{task}{} % numbering of tasks in the section: Answers

%%
% Book metadata
\title{Программирование \\Викиданных}% \\для школьников \\и студентов}
\author[Крижановский и др.]{Крижановский Андрей, Балакирева Мария, Меньшикова Екатерина, \mbox{Паренченков Евгений}, Потес Артём, Трубина Елизавета, \mbox{Обрегон Анхель}}
%\author[Крижановский А. А., Балакирева М. С., Меньшикова Е. А., Паренченков Е. О., Потес А. С., Трубина Е. Д.]{Крижановский Андрей, Балакирева Мария, Меньшикова Екатерина, Паренченков Евгений, Потес Артём, Трубина Елизавета}
%\author[Крижановский Андрей, Иванов Иван]{Крижановский Андрей,\ Иванов Иван,\ добавьте свою фамилию и имя ...}
\publisher{Петрозаводский государственный университет,\\Карельский научный центр РАН}

%%
% If they're installed, use Bergamo and Chantilly from www.fontsite.com.
% They're clones of Bembo and Gill Sans, respectively.
%\IfFileExists{bergamo.sty}{\usepackage[osf]{bergamo}}{}% Bembo
%\IfFileExists{chantill.sty}{\usepackage{chantill}}{}% Gill Sans

%\usepackage{microtype}

%%
% Just some sample text
%\usepackage{lipsum}


% table of contents: tocloft
\usepackage{tocloft}
\renewcommand{\cfttoctitlefont}{\huge} % The header "Contents"/"Оглавление" font size (not so huge as default)
\renewcommand\cftchapaftersnum{.}% adds dot after chapter title in ToC
\renewcommand\cftchapdotsep{\cftdotsep}% adds leader dots from chapter titles to page numbers
%\makeatletter \renewcommand{\@dotsep}{4.5} \makeatother % + dots in Table of contents

% "Часть" + \part{} + "."
\dottedcontents{part}[0em]{\sffamily\bfseries\large\protect\addvspace{15pt}Часть}{-5pt}{1pc}
\renewcommand{\thepart}{\Roman{part}.}  % adds dot after part title in ToC

% separate page with "Part II \newline ornament \newline The part title
\usepackage{pgfornament}
\newcommand{\formatpart}[1]{%
    \begin{fullwidth}
    \centering
%    \partname~\thepart%
    \partname~\Roman{part}% without dot at the end: "Part I", not "Part I."

    \vspace*{0.2\baselineskip}
    \pgfornament[width=4cm, color=Sepia]{69}%
    \vspace*{0.5\baselineskip}

    #1%
    \end{fullwidth}%
%    \centering\includegraphics[width=38pt]{./Big-bot-icon.png}
}



\titleformat% Formatting the part header 
  {\part} % command
  [block] % shape
  {\bfseries\sc\Huge} % format todo
  {} % label
  {0pt} % sep - moving "Chapter" to right (to center)
  {\formatpart}

\usepackage{figchild}
\newcommand{\MarginQuestion}{% Lamp image from the package figchild, in the beginning of the questions on margins
\noindent\reflectbox{{% Mirroring the lamp to right (to a question text)
\fcTableLight{0.1}{black}{1}%
}}%
}
\newcommand{\MarginInternalLink}{% Pencil image, reference to other sections
\noindent\reflectbox{{% Mirroring the lamp to right (to a question text)
\fcPencilA{0.06}{black}{1}%
}}\,\,\,% % some space \,%
}

\newcommand{\MarginNB}{% rocket image, Attention, NotaBene
\noindent\fcRocketA{0.1}{black}{1}%
\,\,\,% % some space \,%
}



%\fcBinoculars{0.1}{black}{1}
%\fcFlyingSaucer{0.6}{black}{1}
%\fcPuppy{0.1}{black}{1}
%\fcSeahorse{0.1}{black}{1}

%%
% For nicely typeset tabular material
\usepackage{booktabs}

%%
% For graphics / images
\usepackage{graphicx}
\setkeys{Gin}{width=\linewidth,totalheight=\textheight,keepaspectratio}
\graphicspath{{graphics/}}


% The fancyvrb package lets us customize the formatting of verbatim
% environments.  We use a slightly smaller font.
% \usepackage{fancyvrb}
% \fvset{fontsize=\normalsize}

%%
% Prints argument within hanging parentheses (i.e., parentheses that take
% up no horizontal space).  Useful in tabular environments.
\newcommand{\hangp}[1]{\makebox[0pt][r]{(}#1\makebox[0pt][l]{)}}

%%
% Prints an asterisk that takes up no horizontal space.
% Useful in tabular environments.
\newcommand{\hangstar}{\makebox[0pt][l]{*}}

%%
% Prints a trailing space in a smart way.
\usepackage{xspace}

% $\blackinwhitediamond$ in Answers
\usepackage[notextcomp]{stix} % notexcomp since textcomp is loaded in tufte-common.def
\newcommand{\AnswerBackref}{% 
$\blackinwhitediamond$ %
}



%%
% Some shortcuts for Tufte's book titles.  The lowercase commands will
% produce the initials of the book title in italics.  The all-caps commands
% will print out the full title of the book in italics.
\newcommand{\vdqi}{\textit{VDQI}\xspace}
\newcommand{\ei}{\textit{EI}\xspace}
\newcommand{\ve}{\textit{VE}\xspace}
\newcommand{\be}{\textit{BE}\xspace}
\newcommand{\VDQI}{\textit{The Visual Display of Quantitative Information}\xspace}
\newcommand{\EI}{\textit{Envisioning Information}\xspace}
\newcommand{\VE}{\textit{Visual Explanations}\xspace}
\newcommand{\BE}{\textit{Beautiful Evidence}\xspace}

\newcommand{\TL}{Tufte-\LaTeX\xspace}

% Prints the month name (e.g., January) and the year (e.g., 2008)
\newcommand{\monthyear}{%
  \ifcase\month\or January\or February\or March\or April\or May\or June\or
  July\or August\or September\or October\or November\or
  December\fi\space\number\year
}



% Inserts a blank page
\newcommand{\blankpage}{\newpage\hbox{}\thispagestyle{empty}\newpage}

\usepackage{units}

% Typesets the font size, leading, and measure in the form of 10/12x26 pc.
\newcommand{\measure}[3]{#1/#2$\times$\unit[#3]{pc}}

% Macros for typesetting the documentation
\newcommand{\hlred}[1]{\textcolor{Maroon}{#1}}% prints in red
\newcommand{\hangleft}[1]{\makebox[0pt][r]{#1}}
\newcommand{\hairsp}{\hspace{1pt}}% hair space
\newcommand{\hquad}{\hskip0.5em\relax}% half quad space
\newcommand{\TODO}{\textcolor{red}{\bf TODO!}\xspace}
\newcommand{\na}{\quad--}% used in tables for N/A cells
\providecommand{\XeLaTeX}{X\lower.5ex\hbox{\kern-0.15em\reflectbox{E}}\kern-0.1em\LaTeX}
\newcommand{\tXeLaTeX}{\XeLaTeX\index{XeLaTeX@\protect\XeLaTeX}}
% \index{\texttt{\textbackslash xyz}@\hangleft{\texttt{\textbackslash}}\texttt{xyz}}
\newcommand{\tuftebs}{\symbol{'134}}% a backslash in tt type in OT1/T1
\newcommand{\doccmdnoindex}[2][]{\texttt{\tuftebs#2}}% command name -- adds backslash automatically (and doesn't add cmd to the index)
\newcommand{\doccmddef}[2][]{%
  \hlred{\texttt{\tuftebs#2}}\label{cmd:#2}%
  \ifthenelse{\isempty{#1}}%
    {% add the command to the index
      \index{#2 command@\protect\hangleft{\texttt{\tuftebs}}\texttt{#2}}% command name
    }%
    {% add the command and package to the index
      \index{#2 command@\protect\hangleft{\texttt{\tuftebs}}\texttt{#2} (\texttt{#1} package)}% command name
      \index{#1 package@\texttt{#1} package}\index{packages!#1@\texttt{#1}}% package name
    }%
}% command name -- adds backslash automatically
\newcommand{\doccmd}[2][]{%
  \texttt{\tuftebs#2}%
  \ifthenelse{\isempty{#1}}%
    {% add the command to the index
      \index{#2 command@\protect\hangleft{\texttt{\tuftebs}}\texttt{#2}}% command name
    }%
    {% add the command and package to the index
      \index{#2 command@\protect\hangleft{\texttt{\tuftebs}}\texttt{#2} (\texttt{#1} package)}% command name
      \index{#1 package@\texttt{#1} package}\index{packages!#1@\texttt{#1}}% package name
    }%
}% command name -- adds backslash automatically
\newcommand{\docopt}[1]{\ensuremath{\langle}\textrm{\textit{#1}}\ensuremath{\rangle}}% optional command argument
\newcommand{\docarg}[1]{\textrm{\textit{#1}}}% (required) command argument
\newenvironment{docspec}{\begin{quotation}\ttfamily\parskip0pt\parindent0pt\ignorespaces}{\end{quotation}}% command specification environment
\newcommand{\docenv}[1]{\texttt{#1}\index{#1 environment@\texttt{#1} environment}\index{environments!#1@\texttt{#1}}}% environment name
\newcommand{\docenvdef}[1]{\hlred{\texttt{#1}}\label{env:#1}\index{#1 environment@\texttt{#1} environment}\index{environments!#1@\texttt{#1}}}% environment name
\newcommand{\docpkg}[1]{\texttt{#1}\index{#1 package@\texttt{#1} package}\index{packages!#1@\texttt{#1}}}% package name
\newcommand{\doccls}[1]{\texttt{#1}}% document class name
\newcommand{\docclsopt}[1]{\texttt{#1}\index{#1 class option@\texttt{#1} class option}\index{class options!#1@\texttt{#1}}}% document class option name
\newcommand{\docclsoptdef}[1]{\hlred{\texttt{#1}}\label{clsopt:#1}\index{#1 class option@\texttt{#1} class option}\index{class options!#1@\texttt{#1}}}% document class option name defined
\newcommand{\docmsg}[2]{\bigskip\begin{fullwidth}\noindent\ttfamily#1\end{fullwidth}\medskip\par\noindent#2}
\newcommand{\docfilehook}[2]{\texttt{#1}\index{file hooks!#2}\index{#1@\texttt{#1}}}
\newcommand{\doccounter}[1]{\texttt{#1}\index{#1 counter@\texttt{#1} counter}}


% Tufte book in landscape
% https://tex.stackexchange.com/a/413441/99685
% text the same width, margin width ++
%\geometry{a4paper,landscape,left=24.8mm,top=27.4mm,headsep=2\baselineskip,textwidth=107mm,marginparsep=8.2mm,marginparwidth=136.4mm,textheight=34\baselineskip,headheight=\baselineskip}
% text = 107 mm (old) + 40 mm = 147, margin = 49.4 mm (old) + 47 = 96.4 mm
\geometry{a4paper,landscape,left=24.8mm,top=27.4mm,headsep=2\baselineskip,textwidth=147mm,marginparsep=8.2mm,marginparwidth=96.4mm,textheight=34\baselineskip,headheight=\baselineskip}


% Absolutely, definitely, preventing page break, https://tex.stackexchange.com/a/94702/99685
%\newenvironment{absolutelynopagebreak}
%  {\par\nobreak\vfil\penalty0\vfilneg
%   \vtop\bgroup}
%  {\par\xdef\tpd{\the\prevdepth}\egroup
%   \prevdepth=\tpd}


% Generates the index
\usepackage{makeidx}
\makeindex

\begin{document}
\sisetup{mode=text} % Trying to get the same font when using SI units in text and math mode 

% Front matter
%\frontmatter

% r.1 blank page
%\blankpage

% r.3 full title page
\maketitle


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Let's comment out this page 
%\iffalse

% v.4 copyright page
\newpage
\begin{fullwidth}
УДК 004 \\
ББК 32.973 \\
\hphantom{ББК} П784
~\vfill
\thispagestyle{empty}
\setlength{\parindent}{0pt}
\setlength{\parskip}{\baselineskip}

Это учебник по Викиданным и языку SPARQL. 
Викиданные~--- это огромная база данных, лежащая в основе Википедии и связывающая вики-проекты воедино.
Прочитав книгу, вы сможете извлекать из Викиданных информацию с~помощью SPARQL-скриптов, 
затем обрабатывать её и строить по ней таблицы, графики и карты. \\ 
Учебник предназначен для студентов, %Института математики и информационных технологий ПетрГУ, 
изучающих информатику, 
для тех, кто хочет развить свои аналитические навыки, 
    научиться программировать 
    и глубже разбираться в принципах работы самого компьютерного вики-проекта. \\
%Книга писалась одновременно с созданием учебного курса <<Программирование Викиданных>> в Викиверситете. 
    Дополнительные материалы доступны онлайн 
    (\href{https://w.wiki/62E}{https://ru.wikiversity.org/wiki/Программирование\_Викиданных}) 
    в одноимённом курсе Викиверситета.
Учебник распространяется на правах свободной лицензии 
    \href{https://creativecommons.org/licenses/by-sa/4.0/deed.ru}{Creative Commons Attribution-ShareAlike}.

Copyleft \textcopyleft\ \the\year\ \thanklessauthor

%\par\smallcaps{Published by \thanklesspublisher}
%\par\smallcaps{\thanklesspublisher}
\par{\thanklesspublisher}

%\par\textit{First printing, \monthyear}


\end{fullwidth}
\newpage
%\fi 
\begin{fullwidth}
% eo of commented out page
%%%%%%%%%%%%%%%%%%%%%%%%%%



% r.5 contents
\tableofcontents

\end{fullwidth}


% r.7 dedication
\clearpage
\vfill
\begin{fullwidth}

% a small hack to fix the hsize, to align epigraph block right
% https://stackoverflow.com/a/31522918/1173350
\makeatletter\setlength\hsize{\@tufte@fullwidth}\makeatother

\renewcommand{\epigraphsize}{\Large}
\renewcommand{\epigraphflush}{flushright}
\setlength{\epigraphwidth}{.7\linewidth}

\epigraph{Что может быть проще примитивного нуль-передатчика? Только примитивный нуль-аккумулятор.}%
{\fontfamily{iwona}\selectfont%
\textit{Обитаемый остров\\Аркадий и Борис Стругацкие}%
}%eo fontfamily

\vspace{36px}

\epigraph{%
Эта машина, подпиравшая стены железными боками, была огромна. Электроник, поглощая цифры, скоро пришёл к выводу, что ему нужно сидеть здесь несколько суток\dots\\
---~Я всего этого не запомню,~--- скрипуче сказал Электроник. ---~Миллионы цифр! Слишком большое количество информации\dots\\
Профессор положил руку на его плечо.\\
---~Отключись,~--- посоветовал он. ---~Привыкать надо постепенно.}%
{\fontfamily{iwona}\selectfont%
\textit{Рэсси~--- неуловимый друг\\Евгений Велтистов}%
}%eo fontfamily

    
\vspace{56px}


\setlength{\epigraphrule}{0pt} % rm the rule (line)
\epigraph{%
{\fontfamily{iwona}\selectfont%
\textit{\textbf{Издание посвящается изобретателям SPARQL-скриптов~--- программистам будущего, 
а~также OSINT-разведчикам, для которых Викиданные будут школьным полигоном}}%
}%eo fontfamily
}{}
\end{fullwidth}


% r.9 introduction
%\cleardoublepage

\input{./intro/intro.tex}

%%
% Start the main matter (normal chapters)
\mainmatter






\part{Основы Викиданных}%
\label{part:foundation}%


\iffalse
\input{./intro/listings_about.tex}
\input{./review/about_wd.tex}
\input{./intro/buckets_and_balls.tex}
%%%\fi %eo iffalse

\part{Исследуем объекты Викиданных}
\label{part:research}
\input{./chapter/aircraft.tex}

%%%\iffalse
\input{./chapter/anime.tex}

\input{./chapter/human_settlement.tex}
\input{./chapter/city.tex}

\input{./chapter/country.tex}
\input{./chapter/oblast_of_Russia.tex}

\fi %eo iffalse
\ifnumequal{\value{draft}}{1}{%
  \input{./chapter/musical_composition.tex}
  \input{./chapter/national_park.tex}
  \input{./chapter/radio_station.tex}
}

\iffalse
\input{./chapter/operating_system.tex}
\input{./chapter/programming_language.tex}

%\fi %eo iffalse2
\input{./chapter/ship.tex}
\input{./chapter/spacecraft_space_station.tex}

\part{Специальные возможности вики-проектов и Викиданных}
\label{part:advanced}
\input{./intro/prowd.tex}
\input{./advanced/page_protection.tex}
\input{./advanced/bots.tex}
\fi %eo iffalse

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Заключительная часть 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\dottedcontents{part}[0em]{\sffamily\bfseries\large\protect\addvspace{15pt}Часть}{-5pt}{1pc}
\dottedcontents{part}[0em]{\sffamily\bfseries\large\protect\addvspace{15pt}}{0pt}{1pc}

% "Заключительная часть" without "Часть III"
\renewcommand{\formatpart}[1]{%
    \begin{fullwidth}
    \centering%
    \pgfornament[width=4cm, color=Sepia]{69}%
    \vspace*{0.5\baselineskip}

    #1%
    \end{fullwidth}%
    }
\titleformat% Formatting the part header 
  {\part} % command
  [block] % shape
  {\bfseries\sc\Huge} % format
  {} % label
  {0pt} % sep
  {\formatpart}

\part*{Заключительная часть}
%\addcontentsline{toc}{part}{Заключительная часть}
\label{part:conclusion}
\input{./chapter/answers.tex}

%%
% The back matter contains appendices, bibliographies, indices, glossaries, etc.
\backmatter % \clearpage
%\cleardoublepage

\begin{fullwidth}
%\phantomsection
%\addcontentsline{toc}{chapter}{\listfigurename}
%\listoffigures

%\phantomsection
%\addcontentsline{toc}{chapter}{\listtablename}
%\listoftables

% source biblatex-gost URL: page 24, https://ctan.math.illinois.edu/macros/latex/contrib/biblatex-contrib/biblatex-gost/doc/biblatex-gost.pdf
\newrefcontext[sorting=ntvy]
\printbibliography[env=gostbibliography,
                   heading=bibintoc]

%\bibliographystyle{plainnat}
%\bibliography{wd_references}
%\printbibliography[heading=bibintoc]
\end{fullwidth}


\pagestyle{plain}% + chapter name in top right in index
\printindex

\end{document}

